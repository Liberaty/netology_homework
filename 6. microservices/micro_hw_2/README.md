# Домашнее задание к занятию «Микросервисы: принципы» - Лепишин Алексей

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.
  
**Решение:**
Для реализации API Gateway можно рассмотреть несколько популярных решений:
1) Nginx (с Lua или OpenResty)
2) Kong (на основе Nginx + OpenResty)
3) Traefik
4) Envoy
5) AWS API Gateway / Yandex API Gateway (если нужен облачный вариант)

Сравнительная таблица:

| Критерий | Nginx (+Lua) |	Kong | Traefik | Envoy | AWS API Gateway |
| --- | --- | --- | --- | --- | --- |
| Маршрутизация	| + (гибкая) |	+ |	+ (автообнаружение) |	+ (динамическая) | + (но ограниченная) |
| Аутентификация |	+ (Lua/JWT) |	+ (плагины) |	+ (Middleware) |	+ (ext_authz) |	+ (IAM, Cognito) |
| HTTPS-терминация	| + |	+ |	+ |	+ |	+ |
| Производительность |	Очень высокая	| Высокая	| Средняя	| Очень высокая	| Зависит от AWS |
| Масштабируемость |	+ (вручную) |	+ (Kong Cluster) |	+ (встроенная)	| + (xDS API) |	Автоматическая |
| Поддержка gRPC |	+ (с модулями) |	+ |	+ |	+ |	+ (частично) |
| Конфигурация |	Конфиг-файлы |	DB/Declarative |	Dynamic (Kubernetes) |	xDS API |	Веб-интерфейс |
| Логирование/Метрики |	+ (сторонние) |	+ (плагины) |	+ (встроенные) |	+ (StatsD, Prometheus) |	CloudWatch |
| Цена |	Бесплатно |	Бесплатно (Enterprise платный) |	Бесплатно |	Бесплатно |	Платная (pay-per-use) |

Лучший выбор: Kong или Envoy  

Kong – специализированный API Gateway с поддержкой:  
- Гибкой маршрутизации (через базу данных или декларативно).
- Встроенной аутентификации (JWT, OAuth2, Keycloak и др.).
- Поддержкой HTTPS и плагинами для мониторинга.
- Хорошо подходит для микросервисных архитектур.

Envoy – более современное решение, если нужна:  
- Высокая производительность и динамическая конфигурация (через xDS API).
- Глубокая интеграция с Kubernetes и Service Mesh (Istio).
- Поддержка gRPC и advanced LB-алгоритмов.

Альтернативы:  
Nginx – если нужен максимальный контроль и минимальные накладные расходы.
Traefik – если используется Kubernetes и нужен простой API Gateway.
AWS API Gateway – если проект уже в AWS и не хочется поддерживать свою инфраструктуру.

Итог:  
Если проект on-premise → Kong.  
Если Kubernetes/Cloud-native → Envoy.  
Если AWS → AWS API Gateway.  

Для большинства случаев Kong – оптимальный баланс функциональности и простоты.  


## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

**Решение:**

Рассмотрим популярные брокеры сообщений, соответствующие требованиям: RabbitMQ, Apache Kafka, NATS (JetStream), Apache Pulsar, Redis Streams

| Критерий                     | RabbitMQ          | Apache Kafka      | NATS JetStream    | Apache Pulsar     | Redis Streams     |
|------------------------------|-------------------|-------------------|-------------------|-------------------|-------------------|
| **Кластеризация**            | Quorum Queues  | Репликация партиций |  JetStream репликация | Многоуровневая репликация | Redis Cluster |
| **Хранение на диске**        | По умолчанию   | Лог-коммит      |  JetStream      | Сегментированное | AOF/RDB       |
| **Производительность**       | 50K msg/s      | 100K-1M msg/s  | 1M+ msg/s      | 100K-500K msg/s | 500K msg/s    |
| **Форматы сообщений**        | Любые             | Любые             | Любые             | Любые             | Любые             |
| **Права доступа**            | Плагины        | SASL/Kerberos  |  NATS 2.0+      | Встроенные      | Redis ACL      |
| **Простота эксплуатации**    | Средняя        | Сложная        | Простая        | Средняя        | Очень простая |
| **Гарантии доставки**        | At-least-once     | At-least-once<br>Exactly-once | At-least-once<br>Exactly-once | At-least-once<br>Exactly-once | At-least-once |

1. RabbitMQ - лучший выбор для:
   - Традиционных очередей задач
   - Микросервисной архитектуры
   - Баланса функциональности и простоты

2. Apache Kafka - оптимален для:
   - Обработки потоковых данных
   - Высоконагруженных систем
   - Сценариев Big Data

3. NATS JetStream - рекомендуется для:
   - Cloud-native приложений
   - Систем с минимальной задержкой
   - Простых в развертывании решений

4. Redis Streams - подходит когда:
   - Уже используется Redis
   - Нужен легковесный брокер
   - Важна простота эксплуатации